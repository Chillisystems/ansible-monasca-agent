---

- name: MONA | Install python deps
  pip:
    name: '{{ item.name }}'
    editable: False
  with_items:
    - name: paramiko

- name: MONA | Clone monasca-plugins repository
  git:
    repo: '{{ agent_custom_plugin_repo_url }}'
    dest: '{{ agent_install_dir }}/cra'
    update: yes
    force: yes

- name: MONA | Deploy plugin files
  file:
     src: '{{ agent_install_dir }}/cra/monasca_agent/collector/checks_d/{{ item }}'
     dest: '{{ agent_custom_plugin_dir }}/cra_{{ item }}'
     state: link
     force: no
  with_items:
    - libvirt.py
  notify:
    - restart monasca-agent

- name: MONA | Create plugin config file
  template:
   dest: '{{ agent_plugin_conf_dir }}/cra_libvirt.yaml'
   owner: '{{ monasca_agent_user }}'
   group: '{{ monasca_group }}'
   mode: 0640
   src: plugins/cra_libvirt/cra_libvirt.yaml.j2
  notify:
    - restart monasca-agent
