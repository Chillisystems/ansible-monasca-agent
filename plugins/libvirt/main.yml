---

#init_config:
#  admin_password: nova
#  admin_tenant_name: service
#  admin_user: nova
#  cache_dir: /dev/shm
#  identity_uri: http://lab-api:5000/v2.0
#  metadata:
#  - scale_group
#  nova_refresh: 14400
#  ping_check: /opt/monasca-agent/bin/ip netns exec NAMESPACE /bin/ping -n -c1 -w1
#    -q
#  vm_probation: 300
#instances: []

- name: MONA | Install libvirt plugin dependiences
  apt:
    name: '{{ item }}'
    state: present
    update_cache: yes
    force: yes
  with_items:
    - build-essential
    - libssl-dev
    - libffi-dev

- name: MONA | Install libvirt plugin python libs
  pip:
    name: '{{ item.name }}'
    version: '{{ item.version | default(omit) }}'
    extra_args: '{{ item.args | default(omit) }}'
    virtualenv_command: virtualenv
    virtualenv: /opt/monasca-agent
  with_items:
    - name: paramiko
  notify:
    - restart monasca-agent

- name: Setup Monasca agent libvirt plugin
  command: bin/monasca-setup -u {{ mon_agent_admin }} -p {{ mon_agent_pass }}
    -s {{ mon_agent_service }} --project_name {{ mon_agent_project }}
    --keystone_url {{ mon_agent_keystone_url }} --monasca_url {{ mon_agent_api_url }}
    --config_dir {{ agent_conf_dir }} --log_dir {{ agent_log_dir }}
    --detection_plugins libvirt
  args:
    chdir: /opt/monasca-agent
    creates: '{{ agent_plugin_conf_dir }}/libvirt.yaml'
  notify:
    - restart monasca-agent
